{% extends "base_with_tailwind.html" %}

{% block content %}
<div class="max-w-4xl mx-auto py-6">
  <h2 class="text-2xl font-bold mb-6">ğŸ“¦ {{ selected_deck.name }} ë´‰ì‚¬êµ¬ì—­ í• ë‹¹í•˜ê¸°</h2>

  <!-- Dockì— í¬í•¨ë˜ì–´ ìˆëŠ” êµ¬ì—­ë¦¬ìŠ¤íŠ¸ë¥¼ í‘œì‹œ ì‹œì‘ -->
  <form method="POST" action="{% url 'deck:remove_territories_from_deck' selected_deck.id %}">
    {% csrf_token %}
    <div class="mb-6 border border-gray-300 rounded-lg p-4 shadow-sm bg-white">
      <div class="flex justify-between items-center mb-3">
        <p class="text-lg font-semibold mb-2">{{ selected_deck.name }} ë´‰ì‚¬êµ¬ì—­ ({{ deck_territories.count }}ê±´)</p>
        {% if deck_territories %}
        <button type="submit" class="mt-2 px-3 py-1 text-sm bg-red-600 text-white rounded hover:bg-red-700">
          âŒ ì„ íƒ ì œê±°
        </button>
        {% endif %}
      </div>

      {% if deck_territories %}
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 max-h-80 overflow-y-auto">
        {% for t in deck_territories %}
        <label class="cursor-pointer relative block">
          <input type="checkbox" name="remove_territory_ids" value="{{ t.id }}" class="hidden peer">

          <div class="min-h-[70px] rounded shadow p-4 flex flex-col justify-between transition
            {% if t.visit_status == 'old' %}
              bg-red-100 border border-red-300
            {% elif t.visit_status == 'warning' %}
              bg-orange-100 border border-orange-300
            {% else %}
              bg-emerald-100 border border-emerald-300
            {% endif %}
            peer-checked:ring-2 peer-checked:ring-blue-400 peer-checked:border-blue-500">

            <svg class="w-6 h-6 text-blue-600 absolute top-2 right-2 hidden peer-checked:block"
                xmlns="http://www.w3.org/2000/svg"
                fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M5 13l4 4L19 7" />
            </svg>

            <div class="text-sm text-gray-800 leading-tight">
              <div class="font-medium text-blue-800">({{ t.code }}) {{ t.address1 }} {{ t.address2 }}</div>
              {% if t.last_visit %}
              <div class="text-gray-500 text-xs mt-1">ğŸ•’ ë§ˆì§€ë§‰ ë°©ë¬¸: {{ t.last_visit.visited_at|date:"Yë…„mì›”dì¼" }}</div>
              {% else %}
              <div class="text-gray-400 text-xs mt-1">ğŸ“­ ë°©ë¬¸ ê¸°ë¡ ì—†ìŒ</div>
              {% endif %}
            </div>
          </div>
        </label>
        {% endfor %}
      </div>
      {% else %}
        <p class="text-sm text-gray-500">í˜„ì¬ í¬í•¨ëœ Territoryê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      {% endif %}
    </div>
  </form>
  <!-- Dockì— í¬í•¨ë˜ì–´ ìˆëŠ” êµ¬ì—­ë¦¬ìŠ¤íŠ¸ë¥¼ í‘œì‹œ ë -->

  <!-- Deckì— í¬í•¨ì‹œí‚¬ êµ¬ì—­ ë°ì´í„° í‘¯ì‹œ ì‹œì‘  -->
  <div class="mb-6 border border-gray-300 rounded-lg p-4 shadow-sm bg-white">
    <!-- Dockì— êµ¬ì—­ì„ ì¶”ê°€í•˜ê¸° ìœ„í•œ íšŒì¤‘ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì‹œì‘ -->
    <form method="GET" class="mb-6">
      <div class="flex items-center gap-x-4">
        <label for="cong" class="text-gray-700 font-medium whitespace-nowrap">êµ¬ì—­ ì„ íƒ</label>
        <select name="congregation" id="cong"
                class="w-full max-w-xs border-gray-300 rounded-lg shadow-sm"
                onchange="this.form.submit()">
          <option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>
          {% for c in congregations %}
          <option value="{{ c.id }}" {% if selected_cong and c.id == selected_cong.id %}selected{% endif %}>
            {{ c.name }}
          </option>
          {% endfor %}
        </select>
      </div>
    </form>
    <!-- Dockì— êµ¬ì—­ì„ ì¶”ê°€í•˜ê¸° ìœ„í•œ íšŒì¤‘ ì„ íƒ ë“œë¡­ë‹¤ìš´ ë -->

    <!-- ì„ íƒëœ íšŒì¤‘ì— ì†í•œ êµ¬ì—­ ë°ì´í„° í‘œì‹œ ì‹œì‘ -->
    {% if territories %}
      <form method="POST" class="space-y-4">
        {% csrf_token %}
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
          {% for t in territories %}
          <label class="cursor-pointer relative block">
            <input type="checkbox" name="territory_ids" value="{{ t.id }}" class="hidden peer">

            <div class="min-h-[70px] rounded shadow p-4 flex flex-col justify-between transition
              {% if t.visit_status == 'old' %}
                bg-red-100 border border-red-300
              {% elif t.visit_status == 'warning' %}
                bg-orange-100 border border-orange-300
              {% else %}
                bg-emerald-100 border border-emerald-300
              {% endif %}
              peer-checked:ring-2 peer-checked:ring-blue-400 peer-checked:border-blue-500">

              <svg class="w-6 h-6 text-blue-600 absolute top-2 right-2 hidden peer-checked:block"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M5 13l4 4L19 7" />
              </svg>

              <div class="text-sm text-gray-800 leading-tight">
                <div class="font-medium text-blue-800">({{ t.code }}) {{ t.address1 }} {{ t.address2 }}</div>
                {% if t.last_visit %}
                  <div class="text-gray-500 text-xs mt-1">ğŸ•’ ë§ˆì§€ë§‰ ë°©ë¬¸: {{ t.last_visit.visited_at|date:"Yë…„mì›”dì¼" }}</div>
                {% else %}
                  <div class="text-gray-400 text-xs mt-1">ğŸ“­ ë°©ë¬¸ ê¸°ë¡ ì—†ìŒ</div>
                {% endif %}
              </div>
            </div>
          </label>
          {% endfor %}
        </div>

        <!-- ì„ íƒëœ êµ¬ì—­ ê³ ì • í‘œì‹œ ë°” ì‹œì‘ -->
        <input type="hidden" name="deck_id" value="{{ selected_deck.id }}">
        <div id="selectedBar"
            class="fixed bottom-0 left-0 w-full bg-blue-600 text-white px-4 py-3 flex items-center justify-between shadow-lg transition transform translate-y-full"
            style="z-index: 50;">
          <div class="text-sm">
            âœ… ì„ íƒëœ êµ¬ì—­: <span id="selectedCount">0</span>ê°œ
          </div>
          <button type="submit" class="bg-white text-blue-600 px-4 py-1.5 rounded font-semibold hover:bg-gray-100">
            ğŸš€ í• ë‹¹í•˜ê¸°
          </button>
        </div>
        <!-- ì„ íƒëœ êµ¬ì—­ ê³ ì • í‘œì‹œ ë°” ë -->
      </form>
    {% elif selected_cong %}
      <p class="text-sm text-gray-500 mt-4">í•´ë‹¹ ê·¸ë£¹ì— í• ë‹¹ ê°€ëŠ¥í•œ êµ¬ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
    <!-- ì„ íƒëœ íšŒì¤‘ì— ì†í•œ êµ¬ì—­ ë°ì´í„° í‘œì‹œ ë -->
  </div>
  <!-- Deckì— í¬í•¨ì‹œí‚¬ êµ¬ì—­ ë°ì´í„° í‘¯ì‹œ ë  -->
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const checkboxes = document.querySelectorAll('input[name="territory_ids"]');
    const selectedBar = document.getElementById('selectedBar');
    const selectedCount = document.getElementById('selectedCount');

    function updateBar() {
      const count = Array.from(checkboxes).filter(cb => cb.checked).length;
      if (count > 0) {
        selectedCount.textContent = count;
        selectedBar.classList.remove('translate-y-full');
        selectedBar.classList.add('translate-y-0');
      } else {
        selectedBar.classList.add('translate-y-full');
        selectedBar.classList.remove('translate-y-0');
      }
    }

    checkboxes.forEach(cb => cb.addEventListener('change', updateBar));
  });
</script>
{% endblock %}
