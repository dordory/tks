{% extends "base_with_tailwind.html" %}

{% block content %}
<div class="max-w-4xl mx-auto py-6 relative">
  <!-- deck_list로 돌아가기 링크 -->
  <a href="{% url 'territory_manager:deck_list' %}"
     class="fixed top-6 right-6 bg-blue-600 text-white text-sm px-3 py-1.5 rounded-full shadow-lg hover:bg-blue-700 transition z-50">
    <svg class="w-4 h-4 mr-1 inline" fill="none" stroke="currentColor" stroke-width="2"
         viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"></path>
    </svg>
    돌아가기
  </a>

  <h2 class="text-2xl font-bold mb-6">📦 {{ selected_deck.name }} 봉사구역 할당하기</h2>

  {% if territories %}
    <form method="POST" id="assignForm" class="border border-gray-300 rounded-lg p-4 shadow-sm bg-white">
      {% csrf_token %}

      <!-- 드롭다운 -->
      <div class="flex items-center gap-x-4 mb-4">
        <label for="member" class="text-gray-700 font-medium whitespace-nowrap">담당자 선택</label>
        <select name="member" id="member"
                class="w-full max-w-xs border-gray-300 rounded-lg shadow-sm">
          <option value="">-- 선택하세요 --</option>
          {% for m in members %}
          <option value="{{ m.id }}"> {{ m.name }} </option>
          {% endfor %}
        </select>
      </div>

      <!-- Territory 타일 카드 -->
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
        {% for t in territories %}
        <label class="cursor-pointer relative block">
          <input type="checkbox" name="territory_ids" value="{{ t.id }}" class="hidden peer">
          <div class="min-h-[70px] rounded shadow p-4 flex flex-col justify-between transition
            {% if t.visit_status == 'old' %}
              bg-red-100 border border-red-300
            {% elif t.visit_status == 'warning' %}
              bg-orange-100 border border-orange-300
            {% else %}
              bg-emerald-100 border border-emerald-300
            {% endif %}
            peer-checked:ring-2 peer-checked:ring-blue-400 peer-checked:border-blue-500">

            <svg class="w-6 h-6 text-blue-600 absolute top-2 right-2 hidden peer-checked:block"
                 xmlns="http://www.w3.org/2000/svg"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M5 13l4 4L19 7" />
            </svg>

            <div class="text-sm text-gray-800 leading-tight">
              <div class="font-medium text-blue-800">({{ t.code }}) {{ t.address1 }} {{ t.address2 }}</div>
              {% if t.last_visit %}
                <div class="text-gray-500 text-xs mt-1">🕒 마지막 방문: {{ t.last_visit.visited_at|date:"Y년m월d일" }}</div>
              {% else %}
                <div class="text-gray-400 text-xs mt-1">📭 방문 기록 없음</div>
              {% endif %}
            </div>
          </div>
        </label>
        {% endfor %}
      </div>

      <!-- 하단 고정 바 -->
      <div id="bottomBar" class="fixed bottom-0 left-0 right-0 bg-blue-600 border-t border-gray-300 shadow p-4 flex justify-between items-center hidden z-40">
        <div class="text-gray-700 text-sm">
          <span id="selectedCount">0</span>개 구역 선택됨
        </div>
        <button type="submit"
                id="submitButton"
                disabled
                class="bg-white text-blue-600 px-4 py-1.5 rounded font-semibold hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed">
          🚀 할당하기
        </button>
      </div>
    </form>
  {% else %}
    <p class="text-sm text-gray-500 mt-4">할당 가능한 구역이 없습니다.</p>
  {% endif %}
</div>

<script>
  const checkboxes = document.querySelectorAll('input[name="territory_ids"]');
  const bottomBar = document.getElementById('bottomBar');
  const selectedCount = document.getElementById('selectedCount');
  const memberSelect = document.getElementById('member');
  const submitButton = document.getElementById('submitButton');

  function updateButtonState() {
    const hasSelectedTerritories = document.querySelectorAll('input[name="territory_ids"]:checked').length > 0;
    const memberSelected = memberSelect.value !== "";

    // 버튼 활성/비활성
    submitButton.disabled = !(hasSelectedTerritories && memberSelected);
  }

  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', () => {
      const selected = document.querySelectorAll('input[name="territory_ids"]:checked');
      if (selected.length > 0) {
        bottomBar.classList.remove('hidden');
        selectedCount.textContent = selected.length;
      } else {
        bottomBar.classList.add('hidden');
        selectedCount.textContent = 0;
      }
      updateButtonState();
    });
  });

  memberSelect.addEventListener('change', updateButtonState);
</script>
{% endblock %}
