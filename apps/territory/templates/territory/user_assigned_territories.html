{% load static %}
{% load tz %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>{{ congregation.name }}ì˜ Territory ëª©ë¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
</head>
<body class="bg-gray-100 p-2">

<div class="bg-white shadow rounded-lg p-2">
  <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ—‚ï¸ í• ë‹¹ëœ êµ¬ì—­ ëª©ë¡</h2>

  {% if territories %}
  <div class="swiper mySwiper">
  <div class="swiper-wrapper">
    {% for territory in territories %}
    <div class="swiper-slide">
      <div
        class="rounded shadow p-4 flex flex-col justify-between
          {% if territory.visit_status == 'today' %}bg-green-100 border border-green-300
          {% elif territory.visit_status == 'old' %}bg-red-100 border border-red-300
          {% elif territory.visit_status == 'warning' %}bg-orange-100 border border-orange-300
          {% else %}bg-amber-50{% endif %}"
      >
        <!-- ì¹´ë“œ ë‚´ìš© ë™ì¼ -->
        <h3 class="text-lg font-bold text-blue-800 mb-1">{{ territory.address1 }} {{ territory.address2 }}</h3>
        <h3 class="text-lg font-bold text-blue-800 mb-1">{{ territory.address_detail }}</h3>
        <p class="text-sm text-gray-600">ë©”ëª¨: {{ territory.note }}</p>
        {% if territory.last_visited_at %}
        <p class="mt-2 text-xs text-gray-500">
          ğŸ•’ ì§€ë‚œ ë°©ë¬¸: {{ territory.last_visited_at|timezone:"Asia/Tokyo"|date:"Yë…„mì›”dì¼ Hì‹œië¶„" }}
        </p>
        {% else %}
        <p class="mt-2 text-xs text-gray-400">ğŸ“­ ë°©ë¬¸ ê¸°ë¡ ì—†ìŒ</p>
        {% endif %}
        {% if territory.assigned_to %}
        <p class="mt-2 text-xs text-gray-500">
          ğŸ•’ ì„ëª…ëœ ë´‰ì‚¬ì: {{ territory.assigned_to }}
        </p>
        {% else %}
        <p class="mt-2 text-xs text-gray-400">ğŸ“­ ì„ëª…ëœ ë´‰ì‚¬ì ì—†ìŒ</p>
        {% endif %}

        <div class="mt-4 flex justify-between items-center pt-4 border-t">
          <a href="{{ territory.map_link }}"
             target="_blank"
             class="inline-flex items-center space-x-1 px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition whitespace-nowrap">
            ì§€ë„
          </a>
          <a href="{% url 'territory:user_territory_detail' member_id territory.id %}"
             class="inline-flex items-center space-x-1 px-3 py-1 bg-gray-700 text-white text-sm rounded hover:bg-gray-800 transition whitespace-nowrap">
            ìì„¸íˆ ë³´ê¸°
          </a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
  <div class="swiper-button-next"></div>
  <div class="swiper-button-prev"></div>
  
  <!-- í˜ì´ì§€ë„¤ì´ì…˜ (ë™ê·¸ë¼ë¯¸ ì ) -->
  <div class="swiper-pagination"></div>
</div>

  {% else %}
    <p class="text-center text-gray-500">ë“±ë¡ëœ êµ¬ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endif %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const cards = document.querySelectorAll(".territory-card");

    // JST ê¸°ì¤€ ì˜¤ëŠ˜ ë‚ ì§œ ë¬¸ìì—´ ìƒì„±
    const now = new Date();
    const jst = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Tokyo" }));
    const yyyy = jst.getFullYear();
    const mm = String(jst.getMonth() + 1).padStart(2, '0');
    const dd = String(jst.getDate()).padStart(2, '0');
    const todayStr = `${yyyy}-${mm}-${dd}`;

    cards.forEach(card => {
      // data-last-visited-at ì–´íŠ¸ë¦¬ë·°íŠ¸ê°€ ì—†ìœ¼ë©´ ì•„ë˜ëŠ” ë™ì‘ ì•ˆí•¨. í•„ìš”í•œ ê²½ìš° templateì—ì„œ data-last-visited-at ë„£ì–´ì£¼ì„¸ìš”
      const lastVisitedAt = card.getAttribute("data-last-visited-at");
      if (lastVisitedAt === todayStr) {
        card.classList.remove("bg-amber-50");
        card.classList.add("bg-green-100");
      }
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
<script>
  const swiper = new Swiper('.mySwiper', {
    slidesPerView: 1,          // ê¸°ë³¸ 1ê°œ ìŠ¬ë¼ì´ë“œ í‘œì‹œ
    spaceBetween: 16,          // ìŠ¬ë¼ì´ë“œ ì‚¬ì´ ì—¬ë°± (px)
    navigation: {
      nextEl: '.swiper-button-next',
      prevEl: '.swiper-button-prev',
    },
    pagination: {
      el: '.swiper-pagination',
      clickable: true,
    },
    breakpoints: {
      640: {   // sm ì´ìƒ (í…Œë¸”ë¦¿)
        slidesPerView: 2,
      },
      768: {   // md ì´ìƒ
        slidesPerView: 3,
      },
      1024: {  // lg ì´ìƒ (PC)
        slidesPerView: 4,
      }
    }
  });
</script>
</body>
</html>
