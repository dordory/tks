{% load static %}
{% load tz %}
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>{{ congregation.name }}ì˜ Territory ëª©ë¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />

  <!-- Swiper ê¸°ë³¸ ì½˜í…ì¸  ìˆ¨ê¸°ê¸° -->
  <style>
    .swiper-button-prev::after,
    .swiper-button-next::after {
      display: none;
    }
  </style>

</head>
<body class="bg-gray-100 p-2">

<div class="bg-white shadow rounded-lg p-2">
  <h2 class="text-2xl font-bold mb-6 text-gray-800">ğŸ—‚ï¸ í• ë‹¹ëœ êµ¬ì—­ ëª©ë¡</h2>

  {% if territories %}
  <div class="swiper mySwiper relative">
    <div class="swiper-wrapper">
      {% for territory in territories %}
      <div class="swiper-slide">
        <div
          class="rounded shadow p-4 flex flex-col justify-between h-full
            {% if territory.visit_status == 'today' %}bg-green-100 border border-green-300
            {% elif territory.visit_status == 'old' %}bg-red-100 border border-red-300
            {% elif territory.visit_status == 'warning' %}bg-orange-100 border border-orange-300
            {% else %}bg-amber-50{% endif %}"
        >
          <h3 class="text-lg font-bold text-blue-800 mb-1">{{ territory.address1 }} {{ territory.address2 }}</h3>
          <h3 class="text-lg font-bold text-blue-800 mb-1">{{ territory.address_detail }}</h3>
          <p class="text-sm text-gray-600">ë©”ëª¨: {{ territory.note }}</p>

          {% if territory.last_visited_at %}
          <p class="mt-2 text-xs text-gray-500">
            ğŸ•’ ì§€ë‚œ ë°©ë¬¸: {{ territory.last_visited_at|timezone:"Asia/Tokyo"|date:"Yë…„mì›”dì¼ Hì‹œië¶„" }}
          </p>
          {% else %}
          <p class="mt-2 text-xs text-gray-400">ğŸ“­ ë°©ë¬¸ ê¸°ë¡ ì—†ìŒ</p>
          {% endif %}

          {% if territory.assigned_to %}
          <p class="mt-2 text-xs text-gray-500">ğŸ•’ ì„ëª…ëœ ë´‰ì‚¬ì: {{ territory.assigned_to }}</p>
          {% else %}
          <p class="mt-2 text-xs text-gray-400">ğŸ“­ ì„ëª…ëœ ë´‰ì‚¬ì ì—†ìŒ</p>
          {% endif %}

          <div class="mt-4 flex justify-between items-center pt-4 border-t">
            <a href="{{ territory.map_link }}"
               target="_blank"
               class="inline-flex items-center space-x-1 px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition whitespace-nowrap">
              ì§€ë„
            </a>
            <a href="{% url 'territory:user_territory_detail' member_id territory.id %}"
               class="inline-flex items-center space-x-1 px-3 py-1 bg-gray-700 text-white text-sm rounded hover:bg-gray-800 transition whitespace-nowrap">
              ìì„¸íˆ ë³´ê¸°
            </a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
    <!-- ì»¤ìŠ¤í…€ SVG ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
<div class="swiper-button-prev !w-7 !h-7 flex items-center justify-center text-gray-700 bg-white/90 rounded-full shadow-md hover:bg-white absolute top-1/2 -left-4 z-10 cursor-pointer transition duration-150">
  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
  </svg>
</div>

<div class="swiper-button-next !w-7 !h-7 flex items-center justify-center text-gray-700 bg-white/90 rounded-full shadow-md hover:bg-white absolute top-1/2 -right-4 z-10 cursor-pointer transition duration-150">
  <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
  </svg>
</div>

<!-- í˜ì´ì§€ë„¤ì´ì…˜ ì  -->
<div class="swiper-pagination mt-4 mb-2"></div>

<!-- í˜ì´ì§€ ë²ˆí˜¸ (ê·¸ ì•„ë˜) -->
<div id="swiper-page-info" class="text-sm text-center text-gray-600 mb-1"></div>

  {% else %}
  <p class="text-center text-gray-500">ë“±ë¡ëœ êµ¬ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endif %}
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const cards = document.querySelectorAll(".territory-card");

    const now = new Date();
    const jst = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Tokyo" }));
    const yyyy = jst.getFullYear();
    const mm = String(jst.getMonth() + 1).padStart(2, '0');
    const dd = String(jst.getDate()).padStart(2, '0');
    const todayStr = `${yyyy}-${mm}-${dd}`;

    cards.forEach(card => {
      const lastVisitedAt = card.getAttribute("data-last-visited-at");
      if (lastVisitedAt === todayStr) {
        card.classList.remove("bg-amber-50");
        card.classList.add("bg-green-100");
      }
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
<script>
  const swiper = new Swiper('.mySwiper', {
    slidesPerView: 1,
    spaceBetween: 16,
    navigation: {
      nextEl: '.swiper-button-next',
      prevEl: '.swiper-button-prev',
    },
    pagination: {
      el: '.swiper-pagination',
      clickable: true,
    },
    breakpoints: {
      640: { slidesPerView: 2 },
      768: { slidesPerView: 3 },
      1024: { slidesPerView: 4 },
    },
    on: {
      init: updatePageInfo,
      slideChange: updatePageInfo
    }
  });

  function updatePageInfo(swiper) {
    const total = Math.ceil(swiper.slides.length / swiper.params.slidesPerView);
    const current = Math.ceil((swiper.activeIndex + 1) / swiper.params.slidesPerView);
    document.getElementById('swiper-page-info').textContent = `${current} / ${total}`;
  }
</script>
</body>
</html>
